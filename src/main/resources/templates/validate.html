<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Validate</title>
    <style>
        body { font-family: system-ui, Arial, sans-serif; background:#f5f6fa; margin:0; }
        .card { max-width: 560px; margin:40px auto; background:white; padding:24px; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,.08); }
        .row { margin-bottom: 12px; }
        input { width:100%; padding:10px; border-radius:10px; border:1px solid #ced4da; font-size:16px; letter-spacing: 0.5px; box-sizing:border-box; max-width:100%; }
        .btn { padding:12px 18px; border-radius:10px; border:none; background:#2E7D32; color:white; font-size:16px; cursor:pointer; width:100%; }
        .status { margin-top:14px; padding:10px 12px; border-radius:10px; font-weight:600; }
        .ok { background:#d1e7dd; color:#0f5132; }
        .err { background:#f8d7da; color:#842029; }
        .warn { background:#fff3cd; color:#664d03; }
        a.link { text-decoration:none; padding:10px 14px; border-radius:10px; background:#6c757d; color:white; display:inline-block; margin-top:12px; }
        .scanner{margin-top:12px}
        video{width:100%; border-radius:12px; background:#000}
        .row-inline{display:flex; gap:8px; align-items:center}
    </style>
    <script defer src="https://unpkg.com/@zxing/browser@latest"></script>
</head>
<body>
<div class="card">
    <h2>Validate pass</h2>
    <form id="validateForm" action="/validate" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <div class="row">
            <input id="codeInput" name="code" placeholder="Enter or scan code" autofocus>
        </div>
        <div class="row-inline">
            <button class="btn" type="submit">Validate</button>
            <button class="btn" type="button" id="scanBtn" style="background:#2E7D32;">Escanear QR</button>
        </div>
    </form>

    <div class="scanner" id="scanner" style="display:none;">
        <video id="preview"></video>
    </div>

    <div th:if="${status} == 'ok'" class="status ok">
        OK. Uses left: <span th:text="${remaining}">4</span>
    </div>
    <div th:if="${status} == 'noremain'" class="status warn">
        No uses left. Remaining: <span th:text="${remaining}">0</span>
    </div>
    <div th:if="${status} == 'notfound'" class="status err">
        Code not found.
    </div>

    <a class="link" href="/">Back</a>
</div>

<script>
    (function(){
        const scanBtn = document.getElementById('scanBtn');
        const scannerDiv = document.getElementById('scanner');
        const video = document.getElementById('preview');
        const codeInput = document.getElementById('codeInput');
        const form = document.getElementById('validateForm');

        let controls = null;

        scanBtn.addEventListener('click', async () => {
            scannerDiv.style.display = 'block';
            const { BrowserMultiFormatReader } = window.ZXing;
            const reader = new BrowserMultiFormatReader();
            try {
                controls = await reader.decodeFromVideoDevice(undefined, video, (result, err) => {
                    if (result) {
                        codeInput.value = result.getText();
                        if (controls) controls.stop();
                        form.submit();
                    }
                });
            } catch (e) {
                alert('No se pudo acceder a la c√°mara: ' + e);
            }
        });
    })();
</script>
</body>
</html>
